services:
  webstudio:
    build: .
    container_name: webstudio-app
    restart: always
    networks:
      - x00ossw4sogoso80kck480ow
      - coolify
    environment:
      DATABASE_URL: '${DATABASE_URL}'
      DIRECT_URL: '${DIRECT_URL}'
      POSTGREST_API_KEY: '${POSTGREST_API_KEY}'
      POSTGREST_URL: '${POSTGREST_URL}'
      GOOGLE_CLIENT_ID: '${GOOGLE_CLIENT_ID}'
      GOOGLE_CLIENT_SECRET: '${GOOGLE_CLIENT_SECRET}'
      AUTH_SECRET: '${AUTH_SECRET}'
      NODE_ENV: production
      TRUST_PROXY: 'true'
      # --- ESTAS SON LAS VARIABLES QUE ARREGLAN EL ERROR DE URL ---
      APP_URL: 'https://builder.recomiend.app'
      PUBLIC_URL: 'https://builder.recomiend.app'
      COOKIE_DOMAIN: '.builder.recomiend.app' # Punto inicial obligatorio
      # -----------------------------------------------------------
      FEATURES: '${FEATURES}'
      USER_PLAN: '${USER_PLAN}'
      MAX_ASSETS_PER_PROJECT: '${MAX_ASSETS_PER_PROJECT}'
      MAX_UPLOAD_SIZE: '${MAX_UPLOAD_SIZE}'
      DEPLOYMENT_ENVIRONMENT: '${DEPLOYMENT_ENVIRONMENT}'
    
    labels:
      - "traefik.enable=true"
      # ESTA LINEA EVITA EL "NO AVAILABLE SERVICE"
      - "traefik.docker.network=coolify"
      
      # Router HTTPS con sintaxis simplificada para que Coolify no falle el build
      - "traefik.http.routers.webstudio-https.entryPoints=https"
      - "traefik.http.routers.webstudio-https.rule=Host(`builder.recomiend.app`) || HostRegexp(`{subdomain:[a-z0-9-]+}.builder.recomiend.app`)"
      - "traefik.http.routers.webstudio-https.tls=true"
      - "traefik.http.routers.webstudio-https.priority=100"
      
      # Certificado Wildcard
      - "traefik.http.routers.webstudio-https.tls.certresolver=letsencrypt"
      - "traefik.http.routers.webstudio-https.tls.domains[0].main=builder.recomiend.app"
      - "traefik.http.routers.webstudio-https.tls.domains[0].sans=*.builder.recomiend.app"

      # Middlewares
      - "traefik.http.routers.webstudio-https.middlewares=webstudio-proto,gzip"
      - "traefik.http.middlewares.webstudio-proto.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.gzip.compress=true"

      # Redirección HTTP a HTTPS
      - "traefik.http.routers.webstudio-http.entryPoints=http"
      - "traefik.http.routers.webstudio-http.rule=Host(`builder.recomiend.app`) || HostRegexp(`{subdomain:[a-z0-9-]+}.builder.recomiend.app`)"
      - "traefik.http.routers.webstudio-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

      # Vinculación al Servicio
      - "traefik.http.routers.webstudio-https.service=webstudio-svc"
      - "traefik.http.services.webstudio-svc.loadbalancer.server.port=3000"

networks:
  x00ossw4sogoso80kck480ow:
    name: x00ossw4sogoso80kck480ow
    external: true
  coolify:
    name: coolify
    external: true