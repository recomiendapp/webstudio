services:
  postgres:
    image: 'ghcr.io/supabase/postgres:15.1.1.55'
    container_name: webstudio-postgres
    command: 
      - postgres
      - -c
      - log_statement=all
      - -c
      - listen_addresses=*
    environment:
      POSTGRES_USER: '${POSTGRES_USER}'
      POSTGRES_PASSWORD: '${POSTGRES_PASSWORD}'
      POSTGRES_DB: '${POSTGRES_DB}'
      PGDATA: /var/lib/postgresql/data
    volumes:
      - 'postgres_data_v3:/var/lib/postgresql/data'
    # Importante: Exponemos el 5432 Y el 3000 (donde vivirá postgrest)
    ports:
      - '5432:5432'
      - '3000:3000'
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgrest:
    image: 'postgrest/postgrest:v12.2.0'
    container_name: webstudio-postgrest
    # REPLICA DE TU LOCAL: Comparte la red del contenedor de postgres
    network_mode: "service:postgres"
    depends_on:
      postgres:
        condition: service_healthy
    restart: always
    environment:
      # Como comparte red, usamos localhost
      PGRST_DB_URI: 'postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@localhost:5432/${POSTGRES_DB}'
      PGRST_DB_SCHEMAS: 'public'
      PGRST_DB_ANON_ROLE: 'anon' # Ajustado a tu local
      PGRST_JWT_SECRET: '${JWT_SECRET}'
      PGRST_APP_SETTINGS_JWT_SECRET: '${JWT_SECRET}'
      PGRST_DB_USE_LEGACY_GUCS: 'false'

  webstudio:
    build: .
    container_name: webstudio-builder
    # REPLICA: También usa la red de postgres (como en tu inspect)
    network_mode: "service:postgres"
    depends_on:
      postgres:
        condition: service_healthy
    restart: always
    environment:
      NODE_OPTIONS: "--dns-result-order=ipv4first"
      APP_URL: '${APP_URL}'
      DEPLOYMENT_ENVIRONMENT: '${DEPLOYMENT_ENVIRONMENT}'
      DEPLOYMENT_URL: '${DEPLOYMENT_URL}'
      DATABASE_URL: '${DATABASE_URL}'
      DIRECT_URL: '${DIRECT_URL}'
      PUBLIC_URL: '${PUBLIC_URL}'
      GOOGLE_CLIENT_ID: '${GOOGLE_CLIENT_ID}'
      GOOGLE_CLIENT_SECRET: '${GOOGLE_CLIENT_SECRET}'
      POSTGREST_API_KEY: '${POSTGREST_API_KEY}'
      POSTGREST_URL: '${POSTGREST_URL}'
      FEATURES: '${FEATURES}'
      USER_PLAN: '${USER_PLAN}'
      MAX_ASSETS_PER_PROJECT: '${MAX_ASSETS_PER_PROJECT}'
      MAX_UPLOAD_SIZE: '${MAX_UPLOAD_SIZE}'
      PUBLISHER_HOST: '${PUBLISHER_HOST}'
      PUBLISHER_ENDPOINT: '${PUBLISHER_ENDPOINT}'
      BUILD_ORIGIN: '${BUILD_ORIGIN}'
      
volumes:
  postgres_data_v3: