services:
  webstudio:
    build: .
    container_name: webstudio-x00ossw4sogoso80kck480ow
    restart: always
    environment:
      # --- Configuraci贸n de Base de Datos ---
      DATABASE_URL: '${DATABASE_URL}'
      DIRECT_URL: '${DIRECT_URL}'
      POSTGREST_API_KEY: '${POSTGREST_API_KEY}'
      POSTGREST_URL: '${POSTGREST_URL}'
      
      # --- Configuraci贸n de OAuth / Auth ---
      GOOGLE_CLIENT_ID: '${GOOGLE_CLIENT_ID}'
      GOOGLE_CLIENT_SECRET: '${GOOGLE_CLIENT_SECRET}'
      AUTH_SECRET: '${AUTH_SECRET}'
      
      # --- Forzado de Protocolo (Crucial para el Error 400) ---
      NODE_ENV: production
      TRUST_PROXY: 'true'
      APP_URL: 'https://builder.recomiend.app'
      PUBLIC_URL: 'https://builder.recomiend.app'
      
      # --- Otras Variables ---
      FEATURES: '${FEATURES}'
      USER_PLAN: '${USER_PLAN}'
      MAX_ASSETS_PER_PROJECT: '${MAX_ASSETS_PER_PROJECT}'
      MAX_UPLOAD_SIZE: '${MAX_UPLOAD_SIZE}'
      DEPLOYMENT_ENVIRONMENT: '${DEPLOYMENT_ENVIRONMENT}'
    
    ports:
      - '3001:3000' # Puerto que mapeas al exterior (aunque Traefik usa el interno)
    
    labels:
      - "coolify.managed=true"
      - "traefik.enable=true"
      # 1. Usamos solo el punto de entrada HTTP
      - "traefik.http.routers.webstudio-http.entryPoints=http"
      
      # 2. Mantenemos la regla para el dominio y los proyectos
      - "traefik.http.routers.webstudio-http.rule=Host(`builder.recomiend.app`) || HostRegexp(`{subdomain:[a-z0-9-]+}.builder.recomiend.app`)"
      
      # 3. Quitamos TLS por completo (anulamos HTTPS)
      - "traefik.http.routers.webstudio-http.tls=false"
      
      # 4. Vinculaci贸n directa al servicio y puerto
      - "traefik.http.routers.webstudio-http.service=webstudio-svc"
      - "traefik.http.services.webstudio-svc.loadbalancer.server.port=3000"
      
      # 5. IMPORTANTE: Cambiamos la cabecera a HTTP para que la app no busque SSL
      - "traefik.http.middlewares.webstudio-proto.headers.customrequestheaders.X-Forwarded-Proto=http"
      - "traefik.http.routers.webstudio-http.middlewares=webstudio-proto,gzip"

      # 5. Puerto interno de la aplicaci贸n (Webstudio suele usar el 3000 por defecto)
      - "traefik.http.services.webstudio-svc.loadbalancer.server.port=3000"

    networks:
      - x00ossw4sogoso80kck480ow
      - coolify
networks:
  x00ossw4sogoso80kck480ow:
    name: x00ossw4sogoso80kck480ow
    external: true
  coolify:
    external: true